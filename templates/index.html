<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AudioFlow</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@100..900&display=swap" rel="stylesheet">

    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@100..900&family=Noto+Sans+KR:wght@100..900&family=Noto+Sans:wght@100..900&family=Jost:wght@400;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body data-room-id="{{ room_id }}">
    <!-- Fullscreen Color Transition Slide Overlay -->
    <div class="fullscreen-color-slide-overlay" id="fullscreen-color-slide-overlay"></div>
    
    <!-- Fullscreen Lyrics Overlay -->
    <div class="fullscreen-lyrics-overlay" id="fullscreen-lyrics-overlay" style="display: none;">
        <div class="fullscreen-lyrics-content" id="fullscreen-lyrics-content">
            <p class="no-lyrics">No lyrics available</p>
        </div>
    </div>

    <!-- Members Sidebar (Always Visible - Left Side) -->
    <div class="members-sidebar" id="members-sidebar">
        <div class="members-sidebar-header">
            <h3><i class="fa-solid fa-user-group"></i> Members</h3>
        </div>
        <div class="members-sidebar-body" id="members-sidebar-list">
            <p class="loading-members">Loading members...</p>
        </div>
        <div class="sidebar-upload-wrapper">
            <button id="upload-btn" class="control-button sidebar-upload-btn">
                <i class="fas fa-upload"></i> Upload
            </button>
            <input type="file" id="audio-input" accept=".mp3,.wav,.ogg,.flac,.m4a" style="display: none;">
        </div>
    </div>
    
    <style>
      body {
        font-family: 'Noto Sans', 'Noto Sans JP', 'Noto Sans KR', sans-serif;
      }
      .main-heading {
        font-family: 'Jost', Arial, sans-serif;
      }
      .container {
        position: relative;
      }
    </style>

    <!-- Drag and Drop Overlay -->
    <div class="drag-drop-overlay" id="drag-drop-overlay">
        <div class="drag-drop-content">
            <i class="fas fa-cloud-upload-alt drag-drop-icon"></i>
            <div class="drag-drop-text">Drop your music files here</div>
            <div class="drag-drop-hint">Supports MP3, WAV, FLAC, OGG, M4A</div>
        </div>
    </div>

    <!-- Fullscreen Idle Song Info Display -->
    <div class="fullscreen-song-info" id="fullscreen-song-info">
        <div class="fullscreen-song-title" id="fullscreen-song-title"></div>
        <div class="fullscreen-song-artist" id="fullscreen-song-artist"></div>
    </div>

    <div class="container">
        <header class="main-header">
            <h1 class="main-heading">AudioFlow</h1>
            <div class="room-header-controls">
                <div class="room-code-display">Room: <span>{{ room_id }}</span></div>
                <button id="members-badge-btn" class="members-badge-btn" data-tooltip="Members">
                    <i class="fa-solid fa-user-group"></i>
                    <span class="members-badge-count" id="members-badge-count">0</span>
                </button>
                <a href="{{ url_for('create_room') }}" class="create-new-room-button" data-tooltip="Create New Room"><i class="fas fa-plus"></i></a>
                <button class="control-button header-btn mobile-only" id="header-sync-btn" title="Sync" data-tooltip="Sync"><i class="fas fa-sync-alt"></i></button>
                <a href="/" class="exit-room-button" data-tooltip="Exit Room"><i class="fas fa-sign-out-alt"></i></a>
                <button class="control-button header-btn header-fullscreen-btn mobile-only" id="header-fullscreen-btn" title="Toggle Fullscreen" data-tooltip="Fullscreen"><i class="fa-solid fa-up-right-and-down-left-from-center"></i></button>
            </div>
        </header>

        <!-- Scrollable Content Area -->
        <div class="container-scroll-area">
            <!-- Search Section -->
            <div class="search-section" style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                <form id="search-form" class="search-form" onsubmit="event.preventDefault(); return false;" style="flex: 1; max-width: 600px; margin: 0;">
                    <div class="search-input-wrapper">
                        <i class="fas fa-search search-icon"></i>
                        <input id="search-input" type="text" placeholder="Search for music..." value="" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" class="search-input" />
                        <button id="search-btn" type="button" class="search-btn" title="Search">
                            <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </form>
                <button class="control-button player-btn desktop-only" id="queue-btn" title="Queue">
                    <i class="fas fa-list"></i>
                    <span class="queue-badge" id="queue-count">0</span>
                </button>
            </div>

            <!-- Music Library Grid -->
            <div class="music-grid" id="music-grid">
                <!-- Music items will be dynamically added here -->
                <div class="music-grid-empty">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <p>No music uploaded yet</p>
                    <p class="music-grid-hint">Drag & drop files or click upload button</p>
                </div>
            </div>

            <!-- Queue View (Hidden by default) -->
            <div class="queue-view" id="queue-view" style="display: none;">
                <div id="queue-list" class="queue-list">
                    <!-- Queue items injected here -->
                </div>
            </div>
        </div>

        <!-- Now Playing Section (Hidden by default, shown when playing) -->
        <div class="now-playing-section" id="now-playing-section" style="display: none;">
            <div class="cover-section">
                <div class="cover-dancing-bars left">
                    <span class="bar"></span>
                    <span class="bar"></span>
                    <span class="bar"></span>
                </div>
                <img id="cover-art" src="" alt="Cover Art" style="display:none;" />
                <div class="cover-art-placeholder" id="cover-art-placeholder">
                    <!-- Music note icon will be added via CSS -->
                </div>
                <div class="cover-dancing-bars right">
                    <span class="bar"></span>
                    <span class="bar"></span>
                    <span class="bar"></span>
                </div>
            </div>

            <div id="file-name" class="file-status">
            <div id="song-title">No file selected</div>
            <div id="song-artist"></div>
            <script>
            // Add 'long' class if file name is too long and set animation distance
            function updateFileNameAnimation() {
                const titleEl = document.getElementById('song-title');
                const artistEl = document.getElementById('song-artist');
                const container = document.getElementById('file-name');
                if (!titleEl || !container) return;

                const SCROLL_SPEED_PPS = 50; // Pixels per second (consistent speed)
                const MIN_ANIMATION_DURATION = 6; // Minimum duration in seconds
                const PAUSE_RATIO = 0.3; // 30% of time spent pausing (split between positions)

                [titleEl, artistEl].forEach(el => {
                    if (!el) return;
                    
                    requestAnimationFrame(() => {
                        // Reset properties to get accurate measurements
                        el.classList.remove('long');
                        container.classList.remove('is-overflowing');
                        el.style.removeProperty('--slide-distance');
                        el.style.removeProperty('--slide-duration');

                        // Force a reflow to apply the reset
                        void el.offsetWidth;

                        const containerWidth = container.offsetWidth;
                        const textWidth = el.scrollWidth;
                        const isOverflowing = textWidth > containerWidth;

                        if (isOverflowing) {
                            el.classList.add('long');
                            container.classList.add('is-overflowing');

                            // Calculate the exact distance needed to show the full text
                            // Move text so that the end of the text aligns with the end of the container
                            const slideDistance = textWidth - containerWidth;
                            el.style.setProperty('--slide-distance', `-${slideDistance}px`);

                            // Calculate duration: movement time (both directions) + pause time
                            // Since we're moving back and forth, we need time for both directions
                            const onewayMoveDuration = slideDistance / SCROLL_SPEED_PPS;
                            const totalMoveDuration = onewayMoveDuration * 2; // Back and forth
                            const totalDuration = Math.max(totalMoveDuration / (1 - PAUSE_RATIO), MIN_ANIMATION_DURATION);
                            el.style.setProperty('--slide-duration', `${totalDuration}s`);
                            
                            console.log(`Text sliding back-and-forth: ${slideDistance.toFixed(0)}px over ${totalDuration.toFixed(1)}s at ${SCROLL_SPEED_PPS}px/s`);
                        } else {
                            console.log(`Text fits: ${textWidth}px <= ${containerWidth}px`);
                        }
                    });
                });
            }
            window.addEventListener('DOMContentLoaded', updateFileNameAnimation);
            window.addEventListener('resize', updateFileNameAnimation);
            // This function is now called from script.js on player state changes
            </script>
            </div>
        </div>

        <audio id="player" preload="auto" style="display: none;">
            Your browser does not support the audio element.
        </audio>

        <!-- Controls section removed - upload moved to sidebar, sync moved to player -->

        <!-- Fullscreen Toggle Button (hidden by default, shown when audio is loaded) -->
        <!-- Lyrics Modal -->
        <div id="lyrics-modal" class="lyrics-modal" style="display: none;">
            <div class="lyrics-modal-content">
                <div class="lyrics-modal-header">
                    <h3>Lyrics</h3>
                    <button id="close-lyrics" class="close-lyrics-btn">&times;</button>
                </div>
                <div class="lyrics-modal-body">
                    <div id="lyrics-content" class="lyrics-content">
                        <p class="no-lyrics">No lyrics available</p>
                    </div>
                    <div id="lyrics-loading" class="lyrics-loading" style="display: none;">
                        <i class="fas fa-spinner fa-spin"></i> Fetching lyrics...
                    </div>
                </div>
            </div>
        </div>

        <!-- Members Modal -->
        <div id="members-modal" class="members-modal" style="display: none;">
            <div class="members-modal-content">
                <div class="members-modal-header">
                    <h4>Room Members</h4>
                    <button id="close-members" class="close-members-btn">&times;</button>
                </div>
                <div class="members-modal-body">
                    <div id="members-list" class="members-list">
                        <p class="loading-members">Loading members...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Queue Modal Removed -->

        <!-- Search Results Modal -->
        <div id="search-modal" class="queue-modal" style="display:none;">
            <div class="queue-modal-content" style="max-width:720px;">
                <div class="queue-modal-header">
                    <h3>Search Results</h3>
                    <button id="close-search" class="close-queue-btn">&times;</button>
                </div>
                <div class="queue-modal-body">
                    <div id="search-results" style="display:flex;flex-direction:column;gap:10px;">
                        <p class="empty-queue">No results yet</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Audio Player Controls (moved outside scroll container to always overlay) -->
    <div class="custom-player">
        <!-- Progress bar row with time displays on sides -->
        <div class="progress-bar-row">
            <span id="current-time" class="time-display">0:00</span>
            <div class="progress-bar-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                    <div class="progress-handle" id="progress-handle"></div>
                </div>
            </div>
            <span id="total-time" class="time-display">0:00</span>
        </div>
        
        <!-- Main playback controls row -->
        <div class="main-player-row">
            <!-- Track info moved inside main-player-row (left side) -->
            <div class="player-track-info">
                <img id="player-thumbnail" src="" alt="Cover" class="player-thumbnail" style="display: none;">
                <div class="player-track-text">
                    <div class="player-track-title" id="player-track-title">No file selected</div>
                    <div class="player-track-artist" id="player-track-artist"></div>
                </div>
            </div>
            <button class="control-button player-btn" id="shuffle-btn" title="Shuffle">
                <i class="fas fa-shuffle" id="shuffle-icon"></i>
            </button>
            
            <button class="control-button player-btn" id="prev-btn" title="Previous Song">
                <i class="fas fa-step-backward"></i>
            </button>
            
            <button class="control-button player-btn play-btn-large" id="play-pause-btn">
                <i class="fas fa-play" id="play-pause-icon"></i>
            </button>
            
            <button class="control-button player-btn" id="next-btn" title="Next Song">
                <i class="fas fa-step-forward"></i>
            </button>
            
            <button class="control-button player-btn" id="loop-btn" title="Loop">
                <i class="fas fa-repeat" id="loop-icon"></i>
            </button>
            
            <button class="control-button player-btn" id="lyrics-toggle-btn" title="Toggle Lyrics">
                <i class="fas fa-music"></i>
            </button>
            
            <div class="volume-control">
                <button class="control-button player-btn volume-btn" id="volume-btn"> 
                    <i class="fas fa-volume-up" id="volume-icon"></i>
                </button>
                <div class="volume-slider-horizontal">
                    <div class="volume-fill-horizontal" id="volume-fill-horizontal"></div>
                    <div class="volume-handle-horizontal" id="volume-handle-horizontal"></div>
                </div>
            </div>
            
            <button class="control-button player-btn desktop-only" id="sync-btn" title="Sync">
                <i class="fas fa-sync-alt"></i>
            </button>
            
            <button class="control-button player-btn desktop-only" id="fullscreen-btn" title="Toggle Fullscreen">
                <i class="fa-solid fa-up-right-and-down-left-from-center" id="fullscreen-icon"></i>
            </button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/color-thief/2.3.2/color-thief.umd.js"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script src="/static/script.js"></script>
</body>
</html>
